/Users/yuanxinyu/workspace/Mira/.venv/lib/python3.12/site-packages/albumentations/__init__.py:28: UserWarning: A new version of Albumentations is available: '2.0.7' (you have '2.0.6'). Upgrade using: pip install -U albumentations. To disable automatic update checks, set the environment variable NO_ALBUMENTATIONS_UPDATE to 1.
  check_for_updates()
ffmpeg version 7.1.1 Copyright (c) 2000-2025 the FFmpeg developers
  built with Apple clang version 16.0.0 (clang-1600.0.26.6)
  configuration: --prefix=/opt/homebrew/Cellar/ffmpeg/7.1.1_1 --enable-shared --enable-pthreads --enable-version3 --cc=clang --host-cflags= --host-ldflags='-Wl,-ld_classic' --enable-ffplay --enable-gnutls --enable-gpl --enable-libaom --enable-libaribb24 --enable-libbluray --enable-libdav1d --enable-libharfbuzz --enable-libjxl --enable-libmp3lame --enable-libopus --enable-librav1e --enable-librist --enable-librubberband --enable-libsnappy --enable-libsrt --enable-libssh --enable-libsvtav1 --enable-libtesseract --enable-libtheora --enable-libvidstab --enable-libvmaf --enable-libvorbis --enable-libvpx --enable-libwebp --enable-libx264 --enable-libx265 --enable-libxml2 --enable-libxvid --enable-lzma --enable-libfontconfig --enable-libfreetype --enable-frei0r --enable-libass --enable-libopencore-amrnb --enable-libopencore-amrwb --enable-libopenjpeg --enable-libspeex --enable-libsoxr --enable-libzmq --enable-libzimg --disable-libjack --disable-indev=jack --enable-videotoolbox --enable-audiotoolbox --enable-neon
  libavutil      59. 39.100 / 59. 39.100
  libavcodec     61. 19.101 / 61. 19.101
  libavformat    61.  7.100 / 61.  7.100
  libavdevice    61.  3.100 / 61.  3.100
  libavfilter    10.  4.100 / 10.  4.100
  libswscale      8.  3.100 /  8.  3.100
  libswresample   5.  3.100 /  5.  3.100
  libpostproc    58.  3.100 / 58.  3.100
Input #0, matroska,webm, from '/private/var/folders/hv/qzzznccs10bbwqtdhf7_9vbh0000gn/T/gradio/6cecc96286b725d335f3571a6ccde6be5a7aaa18339ca9e74529769eaf7e0a11/sample.webm':
  Metadata:
    encoder         : Chrome
  Duration: N/A, start: 0.000000, bitrate: N/A
  Stream #0:0(eng): Video: h264 (Baseline), yuv420p(tv, bt709, progressive), 1920x1440, SAR 1:1 DAR 4:3, 24 fps, 24 tbr, 1k tbn (default)
  Stream #0:1(eng): Audio: opus, 48000 Hz, mono, fltp (default)
Stream mapping:
  Stream #0:0 -> #0:0 (h264 (native) -> vp9 (libvpx-vp9))
  Stream #0:1 -> #0:1 (copy)
Press [q] to stop, [?] for help
[libvpx-vp9 @ 0x14af0b260] v1.15.0
[libvpx-vp9 @ 0x14af0b260] Neither bitrate nor constrained quality specified, using default CRF of 32
Output #0, webm, to '/private/var/folders/hv/qzzznccs10bbwqtdhf7_9vbh0000gn/T/gradio/6cecc96286b725d335f3571a6ccde6be5a7aaa18339ca9e74529769eaf7e0a11/sample_flip.webm':
  Metadata:
    encoder         : Lavf61.7.100
  Stream #0:0(eng): Video: vp9, yuv420p(tv, bt709, progressive), 1920x1440 [SAR 1:1 DAR 4:3], q=2-31, 24 fps, 1k tbn (default)
      Metadata:
        encoder         : Lavc61.19.101 libvpx-vp9
      Side data:
        cpb: bitrate max/min/avg: 0/0/0 buffer size: 0 vbv_delay: N/A
  Stream #0:1(eng): Audio: opus, 48000 Hz, mono, fltp (default)
frame=    6 fps=0.0 q=32.0 size=       1KiB time=00:00:00.25 bitrate=  20.4kbits/s speed= 0.5x    [matroska,webm @ 0x14af04cb0] File ended prematurely at pos. 919259 (0xe06db)
frame=   15 fps= 15 q=30.0 size=       1KiB time=00:00:00.62 bitrate=   8.2kbits/s speed=0.622x    frame=   22 fps= 15 q=32.0 size=       1KiB time=00:00:00.91 bitrate=   5.6kbits/s speed=0.607x    frame=   29 fps= 14 q=27.0 size=       1KiB time=00:00:01.20 bitrate=   4.2kbits/s speed=0.601x    frame=   36 fps= 14 q=32.0 size=       1KiB time=00:00:01.50 bitrate=   3.4kbits/s speed=0.597x    frame=   43 fps= 14 q=30.0 size=       1KiB time=00:00:01.79 bitrate=   2.8kbits/s speed=0.594x    frame=   50 fps= 14 q=32.0 size=       1KiB time=00:00:02.08 bitrate=   2.4kbits/s speed=0.591x    frame=   54 fps= 13 q=32.0 size=       1KiB time=00:00:02.25 bitrate=   2.3kbits/s speed=0.559x    frame=   54 fps= 12 q=32.0 size=       1KiB time=00:00:02.25 bitrate=   2.3kbits/s speed=0.497x    frame=   54 fps= 11 q=32.0 size=       1KiB time=00:00:02.25 bitrate=   2.3kbits/s speed=0.447x    [out#0/webm @ 0x14af064e0] video:667KiB audio:51KiB subtitle:0KiB other streams:0KiB global headers:0KiB muxing overhead: 0.218485%
frame=   78 fps= 15 q=32.0 Lsize=     719KiB time=00:00:03.25 bitrate=1813.3kbits/s speed=0.609x    
[2025-05-16 20:19:49,137][app][process_user_input 65] 视频转换为base64成功，路径: /private/var/folders/hv/qzzznccs10bbwqtdhf7_9vbh0000gn/T/gradio/6cecc96286b725d335f3571a6ccde6be5a7aaa18339ca9e74529769eaf7e0a11/sample_flip.webm, 转换后长度: 982228
[2025-05-16 20:19:49,180][app][process_user_input 92] msg_type: progress
[2025-05-16 20:19:49,934][mira_graph][mira 24] 意图识别结果: 肤质检测
[2025-05-16 20:19:49,937][skin_analysis][wait_for_video_node 23] 进入肤质检测子图
[2025-05-16 20:19:49,938][skin_analysis][extract_best_face_frame 314] [extract_best_face_frame] 接收到base64视频数据，长度: 982228
[2025-05-16 20:19:50,031][skin_analysis][extract_best_face_frame 356] [extract_best_face_frame] 采样到关键帧数: 1
[2025-05-16 20:19:50,438][skin_analysis][extract_best_face_frame 372] [extract_best_face_frame] 第1帧检测到人脸数: 1
[2025-05-16 20:19:50,438][skin_analysis][extract_best_face_frame 382] [extract_best_face_frame] 第1帧关键点数: 5, 置信度: 0.838275671005249
[2025-05-16 20:19:50,444][skin_analysis][extract_best_face_frame 400] [extract_best_face_frame] 已选取最佳帧，关键点数: 5, 置信度: 0.838275671005249
[2025-05-16 20:19:50,457][app][process_user_input 92] msg_type: progress
[2025-05-16 20:19:50,458][skin_analysis][skin_analysis 235] 开始肤质分析，输入base64图片长度: 440440
[2025-05-16 20:19:51,884][skin_analysis][get_access_token 458] [get_access_token] 获取access_token成功: AgcEo0+IAAAAFnljZTozMTk2NDQ0Mzk3OTY1MTc0MjYAAAAAAAAAAQR7caPJgAoCAAAAAAIAAAAAAAAAAAAAAAA=.qd0IHynbJw+GoTMsvtHERd0ybTs=
[2025-05-16 20:19:51,885][skin_analysis][upload_image_for_skin_analysis 31] 开始准备上传肤质分析图片
[2025-05-16 20:19:51,885][skin_analysis][upload_image_for_skin_analysis 50] 请求上传URL
[2025-05-16 20:19:58,615][skin_analysis][upload_image_for_skin_analysis 61] 获取上传URL成功，响应: {"status":200,"result":{"files":[{"content_type":"image/jpeg","file_name":"skin_analysis.jpg","file_id":"jSMY1erC6JKl9WXJpLQvpLY7ZCdFHbsDieIK/lpwJd0LbKfeLEmuXUa9yH4wuc2K","requests":[{"method":"PUT","url":"https://yce-us.s3-accelerate.amazonaws.com/ttl30/319644439796517426/77804398882/v2/aeMNNB0KmUIP8rnQ996tC5Q/0e77d305-4acb-4e49-8c3a-2d08a9dbd2b7.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20250516T121958Z&X-Amz-SignedHeaders=content-length%3Bcontent-type%3Bhost&X-Amz-Expires=7200&X-Amz-Credential=AKIARB77EV5Y5D7DAE3S%2F20250516%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Signature=b7e5a7e26d1961d0359a1ff63694f063114ead4c2b783770b014cb6664087517","headers":{"Content-Length":"330329","Content-Type":"image/jpeg"}}]}]}}
[2025-05-16 20:19:58,615][skin_analysis][upload_image_for_skin_analysis 73] 获取上传URL成功，file_id: jSMY1erC6JKl9WXJpLQvpLY7ZCdFHbsDieIK/lpwJd0LbKfeLEmuXUa9yH4wuc2K
[2025-05-16 20:19:58,615][skin_analysis][upload_image_for_skin_analysis 76] 开始上传文件到https://yce-us.s3-accelerate.amazonaws.com/ttl30/319644439796517426/77804398882/v2/aeMNNB0KmUIP8rnQ996tC5Q/0e77d305-4acb-4e49-8c3a-2d08a9dbd2b7.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20250516T121958Z&X-Amz-SignedHeaders=content-length%3Bcontent-type%3Bhost&X-Amz-Expires=7200&X-Amz-Credential=AKIARB77EV5Y5D7DAE3S%2F20250516%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Signature=b7e5a7e26d1961d0359a1ff63694f063114ead4c2b783770b014cb6664087517
[2025-05-16 20:20:00,595][skin_analysis][upload_image_for_skin_analysis 95] 文件上传成功，file_id: jSMY1erC6JKl9WXJpLQvpLY7ZCdFHbsDieIK/lpwJd0LbKfeLEmuXUa9yH4wuc2K
[2025-05-16 20:20:00,596][skin_analysis][start_skin_analysis_task 109] 开始发起肤质分析任务，file_id: jSMY1erC6JKl9WXJpLQvpLY7ZCdFHbsDieIK/lpwJd0LbKfeLEmuXUa9yH4wuc2K
[2025-05-16 20:20:00,596][skin_analysis][start_skin_analysis_task 136] 发送肤质分析请求：{"request_id": 1747398000, "payload": {"file_sets": {"src_ids": ["jSMY1erC6JKl9WXJpLQvpLY7ZCdFHbsDieIK/lpwJd0LbKfeLEmuXUa9yH4wuc2K"]}, "actions": [{"id": 0, "params": {}, "dst_actions": ["wrinkle", "pore", "texture", "acne", "oiliness", "radiance", "dark_circle_v2"]}]}}
[2025-05-16 20:20:06,777][skin_analysis][start_skin_analysis_task 148] 分析任务API响应：{"status":200,"result":{"task_id":"jSMY1erC6JKl9WXJpLQvpLY7ZCdFHbsDieIK_lpwJd1ITqUk8sOidMFoq9FfW7i4"}}
[2025-05-16 20:20:06,777][skin_analysis][start_skin_analysis_task 150] AI分析任务发起成功，task_id: jSMY1erC6JKl9WXJpLQvpLY7ZCdFHbsDieIK_lpwJd1ITqUk8sOidMFoq9FfW7i4
[2025-05-16 20:20:06,777][skin_analysis][poll_skin_analysis_task 165] 开始轮询任务状态，task_id: jSMY1erC6JKl9WXJpLQvpLY7ZCdFHbsDieIK_lpwJd1ITqUk8sOidMFoq9FfW7i4
[2025-05-16 20:20:12,954][skin_analysis][poll_skin_analysis_task 183] 任务完成
[2025-05-16 20:20:12,954][skin_analysis][poll_skin_analysis_task 186] 获取到结果下载URL: https://yce-us.s3-accelerate.amazonaws.com/ttl30/319644439796517426/77804407037/v2/aeMNNB0KmUIP8rnQ996tC5Q/abef2c92-f184-41e4-8b4a-1843b034d8ed.zip?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20250516T122013Z&X-Amz-SignedHeaders=host&X-Amz-Expires=7200&X-Amz-Credential=AKIARB77EV5Y5D7DAE3S%2F20250516%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Signature=7a859a5c76f0c419fb186df596b8278fce29d54b3d16064b2e8c791455d70e81
[2025-05-16 20:20:19,577][skin_analysis][poll_skin_analysis_task 209] 解析结果成功: {"oiliness": {"raw_score": 78.77114868164062, "ui_score": 80, "output_mask_name": "oiliness_output.png"}, "radiance": {"raw_score": 81.18695616722107, "ui_score": 81, "output_mask_name": "radiance_output.png"}, "dark_circle_v2": {"raw_score": 91.0708636045456, "ui_score": 82, "output_mask_name": "dark_circle_v2_output.png"}, "wrinkle": {"raw_score": 92.81437993049622, "ui_score": 85, "output_mask_name": "wrinkle_output.png"}, "texture": {"raw_score": 94.61352229118347, "ui_score": 89, "output_mask_name": "texture_output.png"}, "pore": {"raw_score": 99.0418119430542, "ui_score": 98, "output_mask_name": "pore_output.png"}, "acne": {"raw_score": 62.871340000000004, "ui_score": 73, "output_mask_name": "acne_output.png"}, "all": {"score": 84.0}}
[2025-05-16 20:20:19,577][skin_analysis][skin_analysis 272] 肤质分析完成
[2025-05-16 20:20:19,579][app][process_user_input 92] msg_type: progress
[2025-05-16 20:20:23,956][app][process_user_input 92] msg_type: structure
[2025-05-16 20:20:23,957][app][process_user_input 119] chat: [{'role': 'assistant', 'content': '1. **检测完成提示**：已完成肤质检测，具体信息可以查看肤质检测结果。\n\n2. **肤质分析说明**：你的皮肤油性程度较高，建议日常使用控油产品并保持良好的清洁习惯。肌肤光泽度和黑眼圈情况为轻度，继续保持早睡早起的好习惯会有所改善。皱纹和肤质纹理处于中等水平，可以通过保湿和抗衰老护理来进一步提升。毛孔问题较为明显，需要特别注意清洁和收缩毛孔的护肤步骤。痘痘情况较轻，但也要注意饮食健康和避免挤压。\n\n3. **情感反馈**：别担心，每个人的皮肤都有自己的特点，坚持正确的护肤方法，你的肌肤会越来越好！\n\n4. **下一步建议**：和Mira说说你最关心的肤质问题是什么吧，我们一起制定最适合你的护肤计划！'}]
[2025-05-16 20:20:23,958][app][process_user_input 120] markdown: {"oiliness": {"raw_score": 78.77114868164062, "ui_score": 80, "output_mask_name": "oiliness_output.png"}, "radiance": {"raw_score": 81.18695616722107, "ui_score": 81, "output_mask_name": "radiance_output.png"}, "dark_circle_v2": {"raw_score": 91.0708636045456, "ui_score": 82, "output_mask_name": "dark_circle_v2_output.png"}, "wrinkle": {"raw_score": 92.81437993049622, "ui_score": 85, "output_mask_name": "wrinkle_output.png"}, "texture": {"raw_score": 94.61352229118347, "ui_score": 89, "output_mask_name": "texture_output.png"}, "pore": {"raw_score": 99.0418119430542, "ui_score": 98, "output_mask_name": "pore_output.png"}, "acne": {"raw_score": 62.871340000000004, "ui_score": 73, "output_mask_name": "acne_output.png"}, "all": {"score": 84.0}}
[2025-05-16 20:20:23,958][app][process_user_input 121] image: <PIL.JpegImagePlugin.JpegImageFile image mode=RGB size=1920x1440 at 0x316589D90>
[2025-05-16 20:20:23,958][app][process_user_input 122] gallery: []
[2025-05-16 20:20:23,958][app][process_user_input 123] profile: None
[2025-05-16 20:20:23,958][app][process_user_input 124] products: []
* Running on local URL:  http://127.0.0.1:7860
* To create a public link, set `share=True` in `launch()`.
{'video_found': True, 'audio_found': True, 'metadata': {'ENCODER': 'Lavf61.7.100'}, 'inputs': [{'streams': [{'input_number': 0, 'stream_number': 0, 'stream_type': 'video', 'language': 'eng', 'default': True, 'size': [1920, 1440], 'bitrate': None, 'fps': 24.0, 'codec_name': 'vp9', 'profile': '(Profile 0)', 'metadata': {'Metadata': '', 'ENCODER': 'Lavc61.19.101 libvpx-vp9', 'DURATION': '00:00:03.250000000'}}, {'input_number': 0, 'stream_number': 1, 'stream_type': 'audio', 'language': 'eng', 'default': True, 'fps': 48000, 'bitrate': None, 'metadata': {'Metadata': '', 'DURATION': '00:00:03.250000000'}}], 'input_number': 0}], 'duration': 3.25, 'bitrate': 1813, 'start': 0.0, 'default_video_input_number': 0, 'default_video_stream_number': 0, 'video_codec_name': 'vp9', 'video_profile': '(Profile 0)', 'video_size': [1920, 1440], 'video_bitrate': None, 'video_fps': 24.0, 'default_audio_input_number': 0, 'default_audio_stream_number': 1, 'audio_fps': 48000, 'audio_bitrate': None, 'video_duration': 3.25, 'video_n_frames': 78}
/Users/yuanxinyu/workspace/Mira/.venv/lib/python3.12/site-packages/imageio_ffmpeg/binaries/ffmpeg-macos-aarch64-v7.1 -i /private/var/folders/hv/qzzznccs10bbwqtdhf7_9vbh0000gn/T/gradio/6cecc96286b725d335f3571a6ccde6be5a7aaa18339ca9e74529769eaf7e0a11/sample_flip.webm -loglevel error -f image2pipe -vf scale=1920:1440 -sws_flags bicubic -pix_fmt rgb24 -vcodec rawvideo -
Applied providers: ['CPUExecutionProvider'], with options: {'CPUExecutionProvider': {}}
find model: /Users/yuanxinyu/.insightface/models/buffalo_l/1k3d68.onnx landmark_3d_68 ['None', 3, 192, 192] 0.0 1.0
Applied providers: ['CPUExecutionProvider'], with options: {'CPUExecutionProvider': {}}
find model: /Users/yuanxinyu/.insightface/models/buffalo_l/2d106det.onnx landmark_2d_106 ['None', 3, 192, 192] 0.0 1.0
Applied providers: ['CPUExecutionProvider'], with options: {'CPUExecutionProvider': {}}
find model: /Users/yuanxinyu/.insightface/models/buffalo_l/det_10g.onnx detection [1, 3, '?', '?'] 127.5 128.0
Applied providers: ['CPUExecutionProvider'], with options: {'CPUExecutionProvider': {}}
find model: /Users/yuanxinyu/.insightface/models/buffalo_l/genderage.onnx genderage ['None', 3, 96, 96] 0.0 1.0
Applied providers: ['CPUExecutionProvider'], with options: {'CPUExecutionProvider': {}}
find model: /Users/yuanxinyu/.insightface/models/buffalo_l/w600k_r50.onnx recognition ['None', 3, 112, 112] 127.5 127.5
set det-size: (640, 640)
Keyboard interruption in main thread... closing server.
Traceback (most recent call last):
  File "/Users/yuanxinyu/workspace/Mira/.venv/lib/python3.12/site-packages/gradio/blocks.py", line 3020, in block_thread
    time.sleep(0.1)
KeyboardInterrupt

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/yuanxinyu/workspace/Mira/app.py", line 180, in <module>
    demo.launch() 
    ^^^^^^^^^^^^^
  File "/Users/yuanxinyu/workspace/Mira/.venv/lib/python3.12/site-packages/gradio/blocks.py", line 2926, in launch
    self.block_thread()
  File "/Users/yuanxinyu/workspace/Mira/.venv/lib/python3.12/site-packages/gradio/blocks.py", line 3024, in block_thread
    self.server.close()
  File "/Users/yuanxinyu/workspace/Mira/.venv/lib/python3.12/site-packages/gradio/http_server.py", line 69, in close
    self.thread.join(timeout=5)
  File "/Users/yuanxinyu/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/lib/python3.12/threading.py", line 1153, in join
    self._wait_for_tstate_lock(timeout=max(timeout, 0))
  File "/Users/yuanxinyu/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/lib/python3.12/threading.py", line 1169, in _wait_for_tstate_lock
    if lock.acquire(block, timeout):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
KeyboardInterrupt
