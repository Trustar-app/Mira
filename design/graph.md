Mira 后端设计

# Mira 智能化妆镜 - 总体流程

## 0. 用户进入系统

- 系统欢迎并简要介绍功能
- 询问用户是否需要创建个人档案
- 提供使用说明及引导

---

## 1. 主流程分支

用户可选择以下任一主流程，系统需支持随时切换或中断当前流程，进入其他流程（支持横跳与中断恢复，详见[LangGraph How-to Guides](https://langchain-ai.github.io/langgraph/how-tos/)）：

### 1.1 聊天互动（默认）

- 支持日常对话、情感陪伴
- 可获取时间、天气、时尚新闻等信息
- 支持设定对话风格/个性
- 支持多模态输入（如视频理解）

### 1.2 创建用户档案

- 触发条件：用户未建档且同意创建，或任意输入要求创建
- 多轮交互采集基础信息（如肤质、偏好等）
- 结果：生成并保存用户档案（长期状态）

### 1.3 肤质检测

- 触发条件：用户任意时刻主动请求
- 流程：引导用户上传/采集面部图像，AI 分析肤质
- 结果：返回肤质分析报告，并更新用户档案

### 1.4 产品推荐

- 触发条件：用户任意时刻主动请求
- 流程：基于用户档案与肤质，智能检索并筛选美妆/护肤产品
- 结果：返回个性化产品推荐列表

### 1.5 产品识别

- 触发条件：用户任意时刻主动请求
- 流程：用户上传产品图片或输入信息，AI 识别产品并分析适配性
- 结果：返回产品详情，并可保存至产品收藏集（长期状态）

### 1.6 护肤/化妆引导

- 触发条件：用户主动请求
- 流程：
  1. 推荐妆容（描述或图片）
  2. 基于用户档案和现有产品，分步指导护肤/化妆流程
  3. 每步可确认、跳过或请求详细说明
  4. 支持流程中随时调用产品识别等子流程
- 结果：流程结束或用户中断，无需显式结果

---

## 2. 流程间切换与中断

- 任意主流程/子流程中，用户可随时切换到其他流程
- 支持流程中断与恢复（如护肤引导中临时识别产品，完成后自动回到原流程）
- 需结合 LangGraph 的分支、子图与状态管理实现（参考[Subgraph](https://langchain-ai.github.io/langgraph/concepts/low_level/#as-a-function)）

---

## 3. 进度与结果反馈

- 所有流程节点均支持流式进度消息（streaming），实时推送至前端聊天界面。
- 前端聊天界面的文本都可以转换为音频，并在前端聊天界面展示
- 关键结果（如肤质报告、产品推荐）推送至结果展示区及用户档案区
- 参考[Streaming Graph Outputs](https://langchain-ai.github.io/langgraph/concepts/streaming/#streaming-graph-outputs-stream-and-astream)

---

## 4. 设计建议

- 各主流程建议实现为独立子图（Subgraph），便于维护与扩展
- 用户档案、对话风格等长期信息建议作为全局 State 管理
- 流程节点需支持 Human-in-the-loop，便于人工干预与体验提升
- 详细节点、状态、分支设计请严格参考[LangGraph 官方文档](https://langchain-ai.github.io/langgraph/how-tos/)

## 5. 前端模块

- 前端用 gradio 实现
- 前端输入有视频、音频和文本输入
- 前端结果展示有 ChatBot 展示对话信息；有结果展示区，展示图片、 图片集、markdown文本；有用户档案区，其中包括用户个人信息和用户拥有的产品集两部分。

## Mira 智能化妆镜后端多智能体与流程编排技术实现方案**。

### 1. 多智能体（Multi-Agent）与 Supervisor 设计

#### 1.1 架构模式

- **Supervisor（聊天智能体）**：主流程中的核心智能体，负责全局对话记忆、用户意图识别、流程调度、总结反馈等。它既能独立与用户对话，也能作为“调度者”调用其他专用智能体或子图。
- **专用智能体/子图**：如肤质检测、产品识别、产品推荐、护肤/化妆引导等，每个流程可实现为独立的 Subgraph，内部可有自己的 Agent（如识别Agent、推荐Agent等）。
- **多智能体协作**：Supervisor 通过 handoff（指令式跳转）或 tool-calling（工具调用）与各专用智能体/子图协作，支持结果回传与总结。

#### 1.2 关键实现要点

- **节点/子图间 handoff**：每个 Agent/Node 可通过返回 `Command` 对象（含 goto、update、graph 参数）实现流程跳转与状态传递。例如，子图内节点可通过 `Command(graph=Command.PARENT, goto="supervisor")` 跳回主 Supervisor 进行总结。
- **消息与状态共享**：Supervisor 维护全局消息历史（如 messages），各子图可通过共享/同步部分 State 与 Supervisor 通信，实现多智能体间的信息流动。
- **多智能体架构选择**：推荐采用“Supervisor（工具调用）”模式，Supervisor 作为决策者，其他 Agent 作为工具/子图被调用，详见[官方多智能体架构](https://langchain-ai.github.io/langgraph/concepts/multi_agent/#multi-agent-architectures)。

---

### 2. 流程切换与中断

#### 2.1 用户主导的流程切换与中断

- **随时中断**：在任何子流程/子图中，用户可通过输入（如“停止”、“返回聊天”，“进入其他流程”）触发流程中断，Supervisor 立即接管，。

#### 2.2 技术实现

- **意图识别**：每个节点/子图入口均可加意图识别逻辑，判断是否需要切换流程。
- **Command 跳转**：通过 `Command(goto="supervisor", graph=Command.PARENT)` 实现流程中断。

---

### 3. 流式进度反馈（Streaming）

#### 3.1 节点中间进度

- **节点返回多次进度**：每个 Node/Agent 可以多次通过 get_stream_writer() 主动推送中间进度信息，这些信息会被流式推送到前端。通过 stream_mode="custom" 获取这些自定义进度数据。
- **分步流式输出**：如产品识别、步骤引导等，均可分阶段推送进度。

#### 3.2 聊天AI流式输出

- **Token 级流式**：对于 LLM 节点，可以用 stream_mode="messages"，每个 token 实时推送到前端。
- **Gradio 前端协作**：前端监听流式消息，实时更新 UI。

**参考文档**：[Streaming Graph Outputs](https://langchain-ai.github.io/langgraph/concepts/streaming/)、[Streaming How-to](https://langchain-ai.github.io/langgraph/how-tos/streaming/)

---

### 4. State 设计与多层 State 协作

#### 4.1 State 结构

- **全局 State（Supervisor/主流程）**：如 user_profile, messages, current_flow, progress, etc.
- **子图 State**：每个 Subgraph 可有独立 State（如 skincare_state, product_state），只需与主 State 共享必要字段。
- **State 映射与转换**：通过 input/output transform，将主 State 与子图 State 映射，保证信息同步。

#### 4.2 State 传递与合并

- **handoff 时 update**：通过 Command 的 update 字段，子图可将结果/状态回传给主流程。
- **多 State schema**：支持不同子图有不同 State schema，必要时通过转换函数实现兼容，详见[State management for subagents](https://langchain-ai.github.io/langgraph/concepts/multi_agent/#state-management-for-subagents)。

---

### 5. 测试与过程监督（LangSmith）

#### 5.1 流程与节点测试

- **单元测试**：每个 Node/Agent/Tool 独立测试输入输出、异常处理。
- **集成测试**：主流程/子流程全链路测试，模拟多轮交互、流程切换等。

#### 5.2 LangSmith 集成

- **流程追踪与回放**：集成 LangSmith，自动记录每次流程执行的输入、输出、状态变更，支持可视化回放与调试。
- **覆盖率与评测**：利用 LangSmith 的 Evals 功能，对关键路径、异常分支进行自动化评测，提升健壮性。
- **断点调试**：支持流程断点、状态回溯，便于定位问题。

**参考文档**：[LangSmith 官方文档](https://docs.smith.langchain.com/)

---

### 项目结构

mira/
│   ├── app.py                 # Gradio/入口启动脚本
│   ├── config.py              # 配置与环境变量
│   ├── state.py               # 全局与子流程 State 结构、reducer、schema 定义
│   ├── graphs/                # 流程编排
│   │   ├── main_graph.py      # 主流程（含Supervisor/调度）
│   │   ├── skincare_graph.py  # 护肤子流程
│   │   ├── makeup_graph.py    # 化妆子流程
│   │   ├── product_graph.py   # 产品相关子流程
│   │   └── ...                # 其他子流程
│   ├── agents/                # 各类智能体实现（一级目录，单一职责，便于扩展）
│   │   ├── supervisor.py
│   │   ├── skincare.py
│   │   ├── makeup.py
│   │   ├── product.py
│   │   └── __init__.py
│   ├── tools/                 # 智能体、工具与流式输出
│   │   ├── media_utils.py     # 视觉分析/图片处理
│   │   ├── llm.py             # LLM调用与流式输出
│   │   ├── product_search.py  # 产品检索/外部API
│   │   ├── streaming.py       # 流式输出相关（自定义writer、消息推送等）
│   │   └── utils.py           # 工具层通用工具
│   ├── utils/                 # 全局通用工具（如日志、配置加载等）
│   │   └── logger.py
│   ├── tests/                 # 单元测试与集成测试
│   │   ├── unit/
│   │   │   ├── test_state.py
│   │   │   ├── test_main_graph.py
│   │   │   ├── test_supervisor_agent.py
│   │   │   ├── test_skincare_agent.py
│   │   │   └── ...
│   │   ├── integration/
│   │   │   ├── test_full_skincare_flow.py
│   │   │   └── ...
│   │   ├── assets/
│   ├── requirements.txt
│   ├── README.md


* 具体实现
`tools/streaming.py`

- 实现流式进度推送工具（如 get_stream_writer 的封装）：
  ```python
  def stream_progress(writer, message: str):
      writer({"progress": message})
  ```



# 流程分解与具体实现

## 肤质检测流程

### 入口条件

- 用户在任意时刻主动请求“肤质检测”功能。

---

### 流程节点与分支

#### 1. 输入采集节点

- **判断**：当前输入是否包含有效视频（或图片）？
  - **是**：进入下一步。
  - **否**：引导用户上传/录制视频，并返回提示信息（流式推送至前端）。

#### 2. 视频有效性分析节点

- **处理**：对用户上传的视频进行分析，提取最佳帧图片。
- **判断**：最佳帧图片中是否检测到人脸关键点？
  - **是**：进入下一步。
  - **否**：返回“未检测到有效人脸，请重新上传视频”提示，并回到“输入采集节点”。

#### 3. 肤质AI检测节点

- **处理**：对最佳帧图片进行AI肤质分析。
- **输出**：生成肤质分析报告（结构化数据+可视化图片）。

#### 4. 结果反馈节点

- **推送**：将肤质分析结果推送至前端结果展示区。
- **对话**：由聊天AI基于分析结果进行个性化解读、建议与互动。

#### 5. 结束/可选分支

- 用户可选择：
  - 结束流程，返回主流程分支。
  - 基于结果继续请求产品推荐、护肤建议等（可直接跳转到相关子流程）。

---

### 技术实现
* 基本建议
- 每个节点建议实现为 LangGraph 的独立 Node，便于状态管理与流式输出。
- 节点间分支（如“无效输入”）可通过 LangGraph 的条件跳转实现，参考[官方分支与子图设计](https://langchain-ai.github.io/langgraph/concepts/low_level/)。
- 进度与提示信息通过 streaming 方式实时推送前端，提升用户体验。
- 关键状态（如最佳帧图片、分析结果）建议存入全局 State，便于后续流程复用。
- 支持 Human-in-the-loop，允许人工干预或补充说明。


* `tools/media_utils.py`
def extract_best_face_frame(video_path):
    """
    从视频中采样关键帧，做人脸检测，选取最佳帧，保存为临时图片，返回图片路径。
    :param video_path: 视频文件路径
    :return: 最佳帧图片路径（str），无有效帧时返回 None
    """



---

## 创建用户档案流程（结构化设计）

### 入口条件

- 用户进入系统后，未检测到有效用户档案，或用户主动请求创建/修改档案。

---

### 流程节点与分支

#### 1. 身份识别节点

- **判断**：用户是否为新用户？
  - **是**：进入“新用户建档流程”。
  - **否**：进入“老用户信息编辑流程”。

---

#### 2. 新用户建档流程

##### 2.1 性别选择节点

- **提问**：请选择你的性别（男/女）。
- **输入**：按钮选择，支持语音输入。
- **校验**：必须选择，方可进入下一题。

##### 2.2 年龄输入节点

- **提问**：请告诉我你的年龄。
- **输入**：文本输入框，支持语音自动填入。
- **校验**：必须填写，方可进入下一题。

##### 2.3 面部特征采集与分析节点

- **引导**：请找到光线较好的地方，正对镜头，上传视频。
- **检测**：判断是否上传视频，以及用户面部是否完整出现在画面中。
  - **是**：开始识别（五官特征、肤色、肤质），展示进度条与提示文案。
  - **否**：提示“请正对镜头”，重新检测。
- **输出**：分析结果。请求用户确认，或者修改后（通过输入）确认。

##### 2.4 化妆专业度打分节点

- **提问**：请给你在化妆方面的专业度打分（0-10分）。
- **输入**：滑动块（整数），0分为小白，10分为专家。
- **校验**：必须选择，方可进入下一题。

##### 2.5 护肤专业度打分节点

- **提问**：请给你在护肤方面的专业度打分（0-10分）。
- **输入**：滑动块（整数），0分为小白，10分为专家。
- **校验**：必须选择，方可进入下一题。

##### 2.6 个人诉求与偏好收集节点

- **提问**：请尽可能多地和我分享你在护肤和化妆中遇到过的问题、诉求或偏好。
- **输入**：上传语音或输入文本
- **输出**：抽取关键信息

##### 2.7 用户名采集节点

- **提问**：告诉mira你叫什么名字吧。
- **输入**：文本输入框，支持语音自动填入。
- **校验**：必须填写，方可完成建档。

##### 2.8 档案生成与保存节点

- **处理**：汇总所有信息，生成用户档案，展示在结果展示区，
- **反馈**：提醒用户可以进一步通过对话来编辑（与后面老用户编辑相同）；欢迎新用户，进入主流程分支。

---

#### 3. 老用户档案编辑流程

##### 3.1 档案编辑

- **提问**：请问需要修改什么信息。
- **输入**：用户输入
- **处理**：处理用户输入信息，修改用户档案，展示在结果展示区，

---

### 技术实现建议

- 每个问题/步骤建议实现为 LangGraph 的独立 Node，便于状态管理与流式输出。
- 所有节点均不允许返回上一题，若中断则下次进入需从第一题重新开始（可通过 State 标记“未完成”状态）。
- 进度与提示信息通过 streaming 方式实时推送前端，提升用户体验。
- 关键状态（如性别、年龄、面部分析结果、专业度、诉求、用户名）建议存入全局 State，便于后续流程复用。
- 支持 Human-in-the-loop，允许人工干预或补充说明。
- 语音与文本输入需无缝切换，前端需配合实现。

当然可以！以下是 Mira 智能化妆镜“产品识别流程”的结构化设计，完全仿照前面“肤质检测流程”和“用户建档流程”的节点与分支风格，便于后续基于 LangGraph 进行技术实现和状态管理。

---

## 产品识别流程（结构化设计）

### 入口条件

- 用户在任意时刻主动请求“产品识别”功能
  例如：

1. 上传视频：视频中拿着一个产品，并说“请识别这个产品，并保存到我的信息库中”
2. 直接输入文本：请保存“欧莱雅男士水能保湿强润霜”到我的信息库中

---

### 流程节点与分支

#### 1. 输入采集节点

- **判断**：当前输入是否包含有效的产品视频或产品关键信息？
  - **是**：进入下一步。
  - **否**：引导用户上传产品图片或输入产品名称/条码，并返回提示信息（流式推送至前端）。

#### 2. 产品信息提取与识别节点

- **处理**：如果有视频，对用户上传的视频进行AI识别，提取产品关键信息（如品牌、品名、型号、条码等）。
- **判断**：是否成功识别出产品？
  - **是**：进入下一步。
  - **否**：返回“未能识别该产品，请重新上传或输入更清晰的信息”提示，并回到“输入采集节点”。

#### 3. 产品信息搜索

- **处理**：基于提取出的产品信息，通过网络搜索，获取与产品相关的结构化信息、包括图片等...
- **输出**：产品结构化信息和总结信息

#### 3. 结果反馈与收藏节点

- **处理**：基于用户档案与产品信息，分析该产品是否适合用户，由聊天AI基于分析结果进行个性化解读、建议与互动，给出适配性建议。可基于结果继续请求产品推荐、护肤/化妆引导等（可直接跳转到相关子流程）。
- **推送**：将产品识别结果与适配性分析推送至前端结果展示区，AI 分析结果推送到 AI Chatbot 区

---

### 技术实现建议

- 每个节点建议实现为 LangGraph 的独立 Node，便于状态管理与流式输出。
- 节点间分支（如“无效输入”或“识别失败”）可通过 LangGraph 的条件跳转实现，参考[官方分支与子图设计](https://langchain-ai.github.io/langgraph/concepts/low_level/)。
- 进度与提示信息通过 streaming 方式实时推送前端，提升用户体验。
- 关键状态（如产品图片、识别结果、适配性分析）建议存入全局 State，便于后续流程复用。
- 支持 Human-in-the-loop，允许人工干预或补充说明。
- 支持多模态输入（图片、文本、语音），前端需配合实现。

---

当然可以！以下是 Mira 智能化妆镜“产品推荐流程”的结构化设计，完全仿照前面“肤质检测流程”“用户建档流程”“产品识别流程”的节点与分支风格，便于后续基于 LangGraph 进行技术实现和状态管理。

---

## 产品推荐流程（结构化设计）

### 入口条件

- 用户在任意时刻主动请求“产品推荐”功能（如通过语音、文本、视频等方式）。

---

### 流程节点与分支

#### 1. 推荐需求采集节点

- **判断**：用户是否明确表达了推荐需求（如“推荐适合我的粉底液”）？
  - **是**：进入下一步。
  - **否**：引导用户补充需求（如“请问你想要推荐哪类产品？有无特殊诉求？”），并流式推送提示至前端。

#### 2. 产品检索与智能筛选节点

- **处理**：基于用户档案、需求、偏好，调用产品数据库/外部API进行检索，智能筛选出最匹配的产品列表。
- **输出**：结构化推荐结果（含产品图片、名称、品牌、适配理由等）。

#### 3. 个性化推荐理由生成节点

- **处理**：由AI基于用户信息和产品特性，生成每个推荐产品的个性化推荐理由和使用建议。
- **推送**：将产品推荐结果（产品卡片+推荐理由）推送至前端结果展示区。

---

### 技术实现建议

- 每个节点建议实现为 LangGraph 的独立 Node，便于状态管理与流式输出。
- 节点间分支（如“信息不全”或“无明确需求”）可通过 LangGraph 的条件跳转实现，参考[官方分支与子图设计](https://langchain-ai.github.io/langgraph/concepts/low_level/)。
- 进度与提示信息通过 streaming 方式实时推送前端，提升用户体验。
- 关键状态（如推荐需求、推荐结果、收藏状态）建议存入全局 State，便于后续流程复用。
- 支持 Human-in-the-loop，允许人工干预或补充说明。
- 支持多模态输入（图片、文本、语音），前端需配合实现。


---

# 护肤/化妆流程

### 入口条件

- 用户请求“护肤引导”或“化妆引导”流程。

---

### 流程节点与分支

#### 1. 用户需求采集节点（统一入口）

- **判断**：用户是否明确表达了本次护肤/化妆的需求？
  - **护肤**：如“今天皮肤有点干，想补水”“想做基础保养”等。
  - **化妆**：如“想要日常淡妆”“有约会，推荐一个适合的妆容”等。
- **操作**：
  - **是**：进入下一步
  - **否**：Mira主动引导用户补充需求（如“请问你今天护肤的主要诉求是什么？”“今天有什么场合需要化妆吗？”），并流式推送提示至前端。

---

#### 2. 产品/妆容推荐与确认节点

- **护肤分支**：
  - **处理**：根据用户需求，系统自动生成本次护肤/化妆方案，包含所需产品种类列表（如爽肤水、乳液、面霜等，仅推荐种类），（如粉底液、遮瑕、修容、眼影等，仅推荐种类），以及拆解后的分步流程（如“第一步：爽肤水/妆前乳，第二步：乳液/粉底液...”）。
  - **推送**：在前端展示模块显式方案。
  - **对话**：引导用户确认或修改推荐产品列表，询问是否缺少产品或有自定义需求。
  - **确认**：用户确认后进入步骤拆解，否则循环，重新设计方案；

---

#### 3. 分步骤引导节点（循环）

- **每一步流程**：
  1. **对话指导**：Mira文本引导用户拿出本步骤产品（如“第一步，拿出爽肤水/粉底液”），Mira给出详细使用手法和情感陪伴文案。
  2. **用户上传**：用户上传视频作为跟随
  3. **反馈与推进**： Mira理解用户视频并给出反馈，推进到下一步
- **循环**：所有步骤完成后，流程结束。

---

#### 6. 结束/可选分支

- **反馈**：Mira总结本次护肤/化妆体验，鼓励用户。

---

## 技术实现建议

- 每个节点建议实现为 LangGraph 的独立 Node，便于状态管理与流式输出。
- 步骤循环建议用子图（Subgraph）实现，支持分步流式输出与状态更新。
- 支持 Human-in-the-loop，允许人工干预或补充说明。
- 支持多模态输入（文本、语音、视频），前端需配合实现。
- 所有流程节点均可随时中断、跳转到其他主流程，支持横跳与恢复。

# Mira 用户个人信息档案结构设计

## 用户特征

### 1. 基本信息（静态/长期）

| 字段名      | 类型     | 说明               | 来源节点     |
| ----------- | -------- | ------------------ | ------------ |
| name        | string   | 用户名             | 用户名采集   |
| gender      | enum     | 性别（男/女/其他） | 性别选择     |
| age         | int      | 年龄               | 年龄输入     |
| create_time | datetime | 档案创建时间       | 系统自动生成 |

---

### 2. 面部与肤质特征（动态/可更新）

| 字段名          | 类型     | 说明                                 | 来源节点             |
| --------------- | -------- | ------------------------------------ | -------------------- |
| face_features   | object   | 五官特征（如脸型、眼型等结构化描述） | 用户档案面部特征采集 |
| skin_color      | string   | 肤色分类（如冷白、暖黄等）           | 面部特征采集         |
| skin_quality    | object   | 肤质分析结果（见下方详细结构）       | 肤质检测             |
| last_skin_check | datetime | 最近一次肤质检测时间                 | 肤质检测             |

#### skin_quality 内容

wrinkle: General wrinkle analysis.
droopy_upper_eyelid: Measures upper eyelid drooping severity.
droopy_lower_eyelid: Measures lower eyelid drooping severity.
firmness: Evaluates skin firmness and elasticity.
acne: Evaluates acne presence.
moisture: Measures skin hydration.
eye_bag: Detects eye bags.
dark_circle_v2: Analyzes dark circles.
age_spot: Detects age spots.
radiance: Evaluates skin brightness.
redness: Measures skin redness.
oiliness: Determines skin oiliness.
pore: Measures pore visibility.
texture: Analyzes overall skin texture.

---

### 3. 专业度与偏好（静态/可更新）

| 字段名               | 类型   | 说明                          | 来源节点       |
| -------------------- | ------ | ----------------------------- | -------------- |
| makeup_skill_level   | int    | 化妆专业度（0-10）            | 化妆专业度打分 |
| skincare_skill_level | int    | 护肤专业度（0-10）            | 护肤专业度打分 |
| user_preferences     | string | 用户自述的护肤/化妆偏好与诉求 | 诉求与偏好收集 |

---

## 产品收藏夹（动态/长期）

| 字段名         | 类型 | 说明                                 | 来源节点          |
| -------------- | ---- | ------------------------------------ | ----------------- |
| owned_products | list | 用户拥有的产品（结构化产品信息列表） | 产品识别/用户维护 |

### 产品信息结构

| 字段名          | 类型     | 说明                                       |
| --------------- | -------- | ------------------------------------------ |
| name            | string   | 产品名称                                   |
| brand           | string   | 品牌                                       |
| type            | string   | 产品类型（如粉底液、面膜等）               |
| image           | url      | 产品图片                                   |
| analysis_report | string   | AI生成的个性化分析文本，包括适配性分析结果 |
| create_time     | datetime | 识别时间                                   |

## 设计说明

- **所有字段建议存储于全局 State，便于流程间调用与长期追踪。**
- **面部与肤质特征可随新检测动态更新。**
- **产品、偏好、专业度等信息支持用户后续主动编辑。**
- **结构可根据后续业务需求灵活扩展。**

---

How to
https://langchain-ai.github.io/langgraph/how-tos/#human-in-the-loop

LangGraph Glossory
https://langchain-ai.github.io/langgraph/concepts/low_level/

* State
  State如何设立 reducers
  https://langchain-ai.github.io/langgraph/how-tos/state-reducers/

State 理解:https://langchain-ai.github.io/langgraph/concepts/low_level/#state
设置什么 reducers
用户的其他基本信息是不是也可以作为 state 传递
对话口吻，能否也作为 state 传递；

* Graph 构造逻辑
  从音频处理开始就是进入图；
  然后是意图识别；
  然后是进入节点（各个子图？）

human-in-the-loop

* Stream 输出
  stream的方式:
  我需要 stream中间进度，每一个 node 可能会有多次更新状态
  https://langchain-ai.github.io/langgraph/concepts/streaming/#streaming-graph-outputs-stream-and-astream

https://langchain-ai.github.io/langgraph/how-tos/streaming/

* Subgraph
  定义 subgraph
  https://langchain-ai.github.io/langgraph/concepts/low_level/#as-a-function
  每次开始新对话，就是新的 checkpointer
* Command
  节点中间可以修改下一个节点
  如何中断中间的对话，跳转到其他对话中呢？是否需要重新判断意图？

如何引用 langSmith？
https://docs.smith.langchain.com/
---------------------------------
